{% extends "base.html" %}
{% block content %}

<div class="hero-wrap">
  <div class="hero-overlay">
    <div class="text-center text-white mb-4">
      <div class="hero-kicker">Î— Î Î¡Î©Î¤Î— ÎšÎŸÎ™ÎÎŸÎ¤Î—Î¤Î‘ BARBERS Î£Î¤Î—Î Î•Î›Î›Î‘Î”Î‘</div>
      <h1 class="hero-title">ÎšÎ»ÎµÎ¯ÏƒÎµ Ï„Î¿ ÏÎ±Î½Ï„ÎµÎ²Î¿Ï ÏƒÎ¿Ï… online</h1>
    </div>

  <div class="mt-4">
  <h3 class="mb-3">Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î±</h3>

  {% if shops %}
    <div class="row g-3">
      {% for s in shops %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-bold">{{ s.name }}</div>
                  <div class="text-muted">{{ s.city }}{% if s.area %} â€¢ {{ s.area }}{% endif %}</div>
                </div>
                <span class="badge bg-dark">{{ s.category }}</span>
              </div>

              {% if s.description %}
                <div class="mt-2 small text-muted">{{ s.description }}</div>
              {% endif %}

              <div class="mt-3 d-flex justify-content-between align-items-center">
                {% if s.is_open %}
                  <span class="badge bg-success">Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ</span>
                {% else %}
                  <span class="badge bg-secondary">ÎšÎ»ÎµÎ¹ÏƒÏ„ÏŒ</span>
                {% endif %}

                <a class="btn btn-sm btn-primary" href="{{ url_for('shop_detail', sid=s.id) }}">
                  Î”ÎµÏ‚ & ÎšÎ»ÎµÎ¯ÏƒÎµ
                </a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î±.</div>
  {% endif %}
</div>


    <form method="get" action="{{ url_for('home') }}" class="hero-search" id="heroSearchForm">

      <!-- Î ÏŒÏ„Îµ -->
      <input
        class="form-control hero-input"
        id="whenInput"
        name="when"
        type="text"
        placeholder="Î ÏŒÏ„Îµ;"
        autocomplete="off"
      />

      <div class="hero-divider"></div>

      <!-- Î Î¿Ï -->
      <div class="dropdown hero-loc">
        <button class="btn hero-loc-btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="whereBtn">
          Î Î¿Ï;
        </button>

        <div class="dropdown-menu p-3 hero-loc-menu">
          <input class="form-control mb-2" name="where" id="whereInput" placeholder="Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· / Î ÏŒÎ»Î·" autocomplete="off">

          <div class="list-group hero-suggest" id="whereSuggest" style="display:none;"></div>

          <button type="button" class="btn btn-outline-light w-100 mt-2" id="nearMeBtn">
            ğŸ“ ÎšÎ¿Î½Ï„Î¬ Î¼Î¿Ï…
          </button>

          <input type="hidden" name="lat" id="latInput">
          <input type="hidden" name="lon" id="lonInput">

          <div class="small text-white-50 mt-2" id="nearMeStatus"></div>
        </div>
      </div>

      <div class="hero-divider"></div>

      <!-- Î¤Î¹ -->
      <div class="dropdown hero-cat">
        <button class="btn hero-loc-btn dropdown-toggle" type="button"
                data-bs-toggle="dropdown" aria-expanded="false" id="whatBtn">
          Î¤Î¹;
        </button>

        <div class="dropdown-menu p-2 hero-cat-menu">
          <button type="button" class="dropdown-item" data-value="">ÎŒÎ»Î±</button>
          <button type="button" class="dropdown-item" data-value="Barber">Barber</button>
          <button type="button" class="dropdown-item" data-value="Hair">Hairdresser</button>
        </div>

        <!-- Î±Ï…Ï„ÏŒ Î¸Î± ÏƒÏ„Î±Î»ÎµÎ¯ ÏƒÏ„Î¿ backend -->
        <input type="hidden" name="cat" id="catInput" value="{{ category or '' }}">
      </div>

      <!-- Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· -->
      <button class="btn btn-primary hero-search-btn px-4" type="submit">
        ğŸ” Î‘ÎÎ‘Î–Î—Î¤Î—Î£Î—
      </button>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // Calendar ÏƒÏ„Î¿ "Î ÏŒÏ„Îµ"
  const whenEl = document.getElementById("whenInput");
  if (whenEl && window.flatpickr) {
    const fp = flatpickr(whenEl, {
      dateFormat: "Y-m-d",
      minDate: "today",
      disableMobile: true,
      clickOpens: true
    });
    whenEl.addEventListener("focus", () => fp.open());
    whenEl.addEventListener("click", () => fp.open());
  }

  // "ÎšÎ¿Î½Ï„Î¬ Î¼Î¿Ï…"
  const nearBtn = document.getElementById("nearMeBtn");
  const statusEl = document.getElementById("nearMeStatus");

  nearBtn?.addEventListener("click", () => {
    statusEl.textContent = "Î•Î½Ï„Î¿Ï€Î¯Î¶Ï‰ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±...";
    if (!navigator.geolocation) {
      statusEl.textContent = "ÎŸ browser Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±.";
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        document.getElementById("latInput").value = pos.coords.latitude;
        document.getElementById("lonInput").value = pos.coords.longitude;
        statusEl.textContent = "ÎŸÎš! Î˜Î± ÏˆÎ¬Î¾Ï‰ ÎºÎ¿Î½Ï„Î¬ ÏƒÎ¿Ï….";
      },
      () => {
        statusEl.textContent = "Î”ÎµÎ½ Î´ÏŒÎ¸Î·ÎºÎµ Î¬Î´ÎµÎ¹Î± Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±Ï‚.";
      },
      { enableHighAccuracy: true, timeout: 8000 }
    );
  });

  // âœ… Free Autocomplete Î³Î¹Î± "Î Î¿Ï;"
  const whereInput = document.getElementById("whereInput");
  const suggestBox = document.getElementById("whereSuggest");
  const whereBtn = document.getElementById("whereBtn");

  async function fetchSuggestions(q) {
    const res = await fetch(`/api/locations?q=${encodeURIComponent(q)}`);
    if (!res.ok) return [];
    return await res.json();
  }

    function renderSuggestions(items) {
    if (!suggestBox) return;
    suggestBox.innerHTML = "";
    if (!items.length) {
      suggestBox.style.display = "none";
      return;
    }


    items.slice(0, 8).forEach(item => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "list-group-item list-group-item-action";
      btn.textContent = item.label;

      btn.addEventListener("click", () => {
        whereInput.value = item.value;
        if (whereBtn) whereBtn.textContent = item.value;
        suggestBox.style.display = "none";
      });

      suggestBox.appendChild(btn);
    });

    suggestBox.style.display = "block";
  }

  let t = null;
  whereInput?.addEventListener("input", () => {
    const q = whereInput.value.trim();
    clearTimeout(t);

    if (q.length < 2) {
      suggestBox.style.display = "none";
      return;
    }

    t = setTimeout(async () => {
      const items = await fetchSuggestions(q);
      renderSuggestions(items);
    }, 200);
  });

  document.addEventListener("click", (e) => {
    if (!suggestBox) return;
    if (suggestBox.contains(e.target) || e.target === whereInput) return;
    suggestBox.style.display = "none";
  });

    // âœ… "Î¤Î¹;" dropdown -> Î³ÎµÎ¼Î¯Î¶ÎµÎ¹ hidden input (cat)
  const catInput = document.getElementById("catInput");
  const whatBtn = document.getElementById("whatBtn");

  // Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· value (Ï€.Ï‡. Î±Ï€ÏŒ querystring), Î³ÏÎ¬Ïˆâ€™ Ï„Î¿ ÏƒÏ„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯
  if (catInput && whatBtn && catInput.value) {
    whatBtn.textContent = (catInput.value === "Hair") ? "Hairdresser" : catInput.value;
  }

  document.querySelectorAll(".hero-cat-menu .dropdown-item").forEach((item) => {
    item.addEventListener("click", () => {
      const val = item.getAttribute("data-value") || "";
      if (catInput) catInput.value = val;

      if (whatBtn) {
        if (!val) whatBtn.textContent = "Î¤Î¹;";
        else if (val === "Hair") whatBtn.textContent = "Hairdresser";
        else whatBtn.textContent = val; // Barber
      }
    });
  });


});
</script>

{% endblock %}
